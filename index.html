<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.4">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.4" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta name="description" content="一人我饮酒醉 七八个小姐姐一起睡">
<meta property="og:type" content="website">
<meta property="og:title" content="樱丸小头子的blog">
<meta property="og:url" content="http://blog.vonyan.cn/index.html">
<meta property="og:site_name" content="樱丸小头子的blog">
<meta property="og:description" content="一人我饮酒醉 七八个小姐姐一起睡">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="樱丸小头子的blog">
<meta name="twitter:description" content="一人我饮酒醉 七八个小姐姐一起睡">






  <link rel="canonical" href="http://blog.vonyan.cn/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>樱丸小头子的blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">樱丸小头子的blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">一人我饮酒醉 七八个小姐姐一起睡</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />Commonweal 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2018/10/10/jvm/G1垃圾收集器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/10/jvm/G1垃圾收集器/" itemprop="url">G1垃圾收集器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-10T14:55:00+08:00">2018-10-10</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-10-10T15:43:28+08:00">2018-10-10</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="G1垃圾收集器"><a href="#G1垃圾收集器" class="headerlink" title="G1垃圾收集器"></a>G1垃圾收集器</h2><p><a href="http://blog.jobbole.com/109170/" target="_blank" rel="noopener">原载</a></p>
<h3 id="取消新生代-老年代的屋里空间划分"><a href="#取消新生代-老年代的屋里空间划分" class="headerlink" title="取消新生代, 老年代的屋里空间划分"></a>取消新生代, 老年代的屋里空间划分</h3><p>使用G1垃圾收集器后, 不用再单独对每个代划分空间. 取而代之的是，G1算法将堆划分为若干个区域（Region），它仍然属于分代收集器。不过，这些区域的一部分包含新生代，新生代的垃圾收集依然采用暂停所有应用线程的方式，将存活对象拷贝到老年代或者Survivor空间。老年代也分成很多区域，G1收集器通过将对象从一个区域复制到另外一个区域，完成了清理工作。这就意味着，在正常的处理过程中，G1完成了堆的压缩（至少是部分堆的压缩），这样也就不会有cms内存碎片问题的存在了。</p>
<p><img src="http://jbcdn2.b0.upaiyun.com/2016/12/02d155395a44f40be1b7e9f634939cb0.png" alt=""><br>在G1中，还有一种特殊的区域，叫Humongous区域。 如果一个对象占用的空间超过了分区容量50%以上，G1收集器就认为这是一个巨型对象。这些巨型对象，默认直接会被分配在年老代，但是如果它是一个短期存在的巨型对象，就会对垃圾收集器造成负面影响。为了解决这个问题，G1划分了一个Humongous区，它用来专门存放巨型对象。如果一个H区装不下一个巨型对象，那么G1会寻找连续的H分区来存储。为了能找到连续的H区，有时候不得不启动Full GC。</p>
<p>PS：在java 8中，持久代也移动到了普通的堆内存空间中，改为元空间。</p>
<h3 id="对象分配策略"><a href="#对象分配策略" class="headerlink" title="对象分配策略"></a>对象分配策略</h3><p>对象的分配策略分为3个阶段：</p>
<ol>
<li>TLAB(Thread Local Allocation Buffer)线程本地分配缓冲区</li>
<li>Eden区中分配</li>
<li>Humongous区分配</li>
</ol>
<p>TLAB为线程本地分配缓冲区，它的目的为了使对象尽可能快的分配出来。如果对象在一个共享的空间中分配，我们需要采用一些同步机制来管理这些空间内的空闲空间指针。在Eden空间中，每一个线程都有一个固定的分区用于分配对象，即一个TLAB。分配对象时，线程之间不再需要进行任何的同步。</p>
<p>对TLAB空间中无法分配的对象，JVM会尝试在Eden空间中进行分配。如果Eden空间无法容纳该对象，就只能在老年代中进行分配空间。</p>
<p>最后，G1提供了两种GC模式，Young GC和Mixed GC，两种都是Stop The World(STW)的。下面我们将分别介绍一下这2种模式。</p>
<h3 id="G1-Young-GC"><a href="#G1-Young-GC" class="headerlink" title="G1 Young GC"></a>G1 Young GC</h3><p>Young GC主要是对Eden区进行GC，它在Eden空间耗尽时会被触发。在这种情况下，Eden空间的数据移动到Survivor空间中，如果Survivor空间不够，Eden空间的部分数据会直接晋升到年老代空间。Survivor区的数据移动到新的Survivor区中，也有部分数据晋升到老年代空间中。最终Eden空间的数据为空，GC停止工作，应用线程继续执行。</p>
<p><img src="http://jbcdn2.b0.upaiyun.com/2016/12/50877d4b41c80010b1f131de5759b689.png" alt=""><br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/a245f9decda81cbf12f69412d38f3177.png" alt=""><br>这时，我们需要考虑一个问题，如果仅仅GC 新生代对象，我们如何找到所有的根对象呢？ 老年代的所有对象都是根么？那这样扫描下来会耗费大量的时间。于是，G1引进了RSet的概念。它的全称是Remembered Set，作用是跟踪指向某个heap区内的对象引用。<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/bd7d9f4a8e43312cb189863a568c4630.png" alt=""><br>在CMS中，也有RSet的概念，在老年代中有一块区域用来记录指向新生代的引用。这是一种point-out，在进行Young GC时，扫描根时，仅仅需要扫描这一块区域，而不需要扫描整个老年代。</p>
<p>但在G1中，并没有使用point-out，这是由于一个分区太小，分区数量太多，如果是用point-out的话，会造成大量的扫描浪费，有些根本不需要GC的分区引用也扫描了。于是G1中使用point-in来解决。point-in的意思是哪些分区引用了当前分区中的对象。这样，仅仅将这些对象当做根来扫描就避免了无效的扫描。由于新生代有多个，那么我们需要在新生代之间记录引用吗？这是不必要的，原因在于每次GC时，所有新生代都会被扫描，所以只需要记录老年代到新生代之间的引用即可。</p>
<p>需要注意的是，如果引用的对象很多，赋值器需要对每个引用做处理，赋值器开销会很大，为了解决赋值器开销这个问题，在G1 中又引入了另外一个概念，卡表（Card Table）。一个Card Table将一个分区在逻辑上划分为固定大小的连续区域，每个区域称之为卡。卡通常较小，介于128到512字节之间。Card Table通常为字节数组，由Card的索引（即数组下标）来标识每个分区的空间地址。默认情况下，每个卡都未被引用。当一个地址空间被引用时，这个地址空间对应的数组索引的值被标记为”0″，即标记为脏被引用，此外RSet也将这个数组下标记录下来。一般情况下，这个RSet其实是一个Hash Table，Key是别的Region的起始地址，Value是一个集合，里面的元素是Card Table的Index。</p>
<p>Young GC 阶段：</p>
<ul>
<li>阶段1：根扫描 静态和本地对象被扫描</li>
<li>阶段2：更新RS 处理dirty card队列更新RS</li>
<li>阶段3：处理RS 检测从年轻代指向年老代的对象</li>
<li>阶段4：对象拷贝 拷贝存活的对象到survivor/old区域</li>
<li>阶段5：处理引用队列 软引用，弱引用，虚引用处理</li>
</ul>
<h3 id="G1-Mix-GC"><a href="#G1-Mix-GC" class="headerlink" title="G1 Mix GC"></a>G1 Mix GC</h3><p>Mix GC不仅进行正常的新生代垃圾收集，同时也回收部分后台扫描线程标记的老年代分区。</p>
<p>它的GC步骤分2步：</p>
<ol>
<li>全局并发标记（global concurrent marking）</li>
<li>拷贝存活对象（evacuation）</li>
</ol>
<p>在进行Mix GC之前，会先进行global concurrent marking（全局并发标记）。 global concurrent marking的执行过程是怎样的呢？</p>
<p>在G1 GC中，它主要是为Mixed GC提供标记服务的，并不是一次GC过程的一个必须环节。global concurrent marking的执行过程分为五个步骤：</p>
<ul>
<li>初始标记（initial mark，STW）<br>在此阶段，G1 GC 对根进行标记。该阶段与常规的 (STW) 年轻代垃圾回收密切相关。</li>
<li>根区域扫描（root region scan）<br>G1 GC 在初始标记的存活区扫描对老年代的引用，并标记被引用的对象。该阶段与应用程序（非 STW）同时运行，并且只有完成该阶段后，才能开始下一次 STW 年轻代垃圾回收。</li>
<li>并发标记（Concurrent Marking）<br>G1 GC 在整个堆中查找可访问的（存活的）对象。该阶段与应用程序同时运行，可以被 STW 年轻代垃圾回收中断</li>
<li>最终标记（Remark，STW）<br>该阶段是 STW 回收，帮助完成标记周期。G1 GC 清空 SATB 缓冲区，跟踪未被访问的存活对象，并执行引用处理。</li>
<li>清除垃圾（Cleanup，STW）<br>在这个最后阶段，G1 GC 执行统计和 RSet 净化的 STW 操作。在统计期间，G1 GC 会识别完全空闲的区域和可供进行混合垃圾回收的区域。清理阶段在将空白区域重置并返回到空闲列表时为部分并发。</li>
</ul>
<h3 id="三色标记算法"><a href="#三色标记算法" class="headerlink" title="三色标记算法"></a>三色标记算法</h3><p>提到并发标记，我们不得不了解并发标记的三色标记算法。它是描述追踪式回收器的一种有用的方法，利用它可以推演回收器的正确性。 首先，我们将对象分成三种类型的。</p>
<ul>
<li>黑色:根对象，或者该对象与它的子对象都被扫描</li>
<li>灰色:对象本身被扫描,但还没扫描完该对象中的子对象</li>
<li>白色:未被扫描对象，扫描完成所有对象之后，最终为白色的为不可达对象，即垃圾对象</li>
</ul>
<p>当GC开始扫描对象时，按照如下图步骤进行对象的扫描：</p>
<p>根对象被置为黑色，子对象被置为灰色。<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/8efbc44ba3b845e6086a83377e912bb9.png" alt=""></p>
<p>继续由灰色遍历,将已扫描了子对象的对象置为黑色。<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/f56ab01de2138dc3b4a4bb3d50f54594.png" alt=""></p>
<p>遍历了所有可达的对象后，所有可达的对象都变成了黑色。不可达的对象即为白色，需要被清理。<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/c4f581fd4a8877375d54a55e4af27841.png" alt=""></p>
<p>这看起来很美好，但是如果在标记过程中，应用程序也在运行，那么对象的指针就有可能改变。这样的话，我们就会遇到一个问题：对象丢失问题</p>
<p>我们看下面一种情况，当垃圾收集器扫描到下面情况时：<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/5dd0686b02e1898ec1a987c2e1571548.png" alt=""></p>
<p>这时候应用程序执行了以下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A.c=C</span><br><span class="line">B.c=null</span><br></pre></td></tr></table></figure>
<p>这样，对象的状态图变成如下情形：<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/78ad6fbc199fca514a5336b2167bd8f7.png" alt=""></p>
<p>这时候垃圾收集器再标记扫描的时候就会下图成这样：<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/f4765bacd1941792df63c6296ad12e3a.png" alt=""></p>
<p>很显然，此时C是白色，被认为是垃圾需要清理掉，显然这是不合理的。那么我们如何保证应用程序在运行的时候，GC标记的对象不丢失呢？有如下2中可行的方式：</p>
<ol>
<li>在插入的时候记录对象</li>
<li>在删除的时候记录对象<br>刚好这对应CMS和G1的2种不同实现方式：</li>
</ol>
<p>在CMS采用的是增量更新（Incremental update），只要在写屏障（write barrier）里发现要有一个白对象的引用被赋值到一个黑对象 的字段里，那就把这个白对象变成灰色的。即插入的时候记录下来。</p>
<p>在G1中，使用的是STAB（snapshot-at-the-beginning）的方式，删除的时候记录所有的对象，它有3个步骤：</p>
<ol>
<li><p>在开始标记的时候生成一个快照图标记存活对象</p>
</li>
<li><p>在并发标记的时候所有被改变的对象入队（在write barrier里把所有旧的引用所指向的对象都变成非白的）</p>
</li>
<li><p>可能存在游离的垃圾，将在下次被收集</p>
</li>
</ol>
<p>这样，G1到现在可以知道哪些老的分区可回收垃圾最多。 当全局并发标记完成后，在某个时刻，就开始了Mix GC。这些垃圾回收被称作“混合式”是因为他们不仅仅进行正常的新生代垃圾收集，同时也回收部分后台扫描线程标记的分区。混合式垃圾收集如下图：<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/0860c63775ccbc265095b5a844f0d381.png" alt=""></p>
<p>混合式GC也是采用的复制的清理策略，当GC完成后，会重新释放空间。<br><img src="http://jbcdn2.b0.upaiyun.com/2016/12/599b50c478126754a1cc614a85b149bd.png" alt=""></p>
<h3 id="调优实践"><a href="#调优实践" class="headerlink" title="调优实践"></a>调优实践</h3><p>MaxGCPauseMillis调优</p>
<p>前面介绍过使用GC的最基本的参数：</p>
<p>-XX:+UseG1GC -Xmx32g -XX:MaxGCPauseMillis=200</p>
<p>前面2个参数都好理解，后面这个MaxGCPauseMillis参数该怎么配置呢？这个参数从字面的意思上看，就是允许的GC最大的暂停时间。G1尽量确保每次GC暂停的时间都在设置的MaxGCPauseMillis范围内。 那G1是如何做到最大暂停时间的呢？这涉及到另一个概念，CSet(collection set)。它的意思是在一次垃圾收集器中被收集的区域集合。</p>
<ul>
<li>Young GC：选定所有新生代里的region。通过控制新生代的region个数来控制young GC的开销。</li>
<li>Mixed GC：选定所有新生代里的region，外加根据global concurrent marking统计得出收集收益高的若干老年代region。在用户指定的开销目标范围内尽可能选择收益高的老年代region。</li>
</ul>
<p>在理解了这些后，我们再设置最大暂停时间就好办了。 首先，我们能容忍的最大暂停时间是有一个限度的，我们需要在这个限度范围内设置。但是应该设置的值是多少呢？我们需要在吞吐量跟MaxGCPauseMillis之间做一个平衡。如果MaxGCPauseMillis设置的过小，那么GC就会频繁，吞吐量就会下降。如果MaxGCPauseMillis设置的过大，应用程序暂停时间就会变长。G1的默认暂停时间是200毫秒，我们可以从这里入手，调整合适的时间。</p>
<p>其他调优参数</p>
<p>-XX:G1HeapRegionSize=n</p>
<p>设置的 G1 区域的大小。值是 2 的幂，范围是 1 MB 到 32 MB 之间。目标是根据最小的 Java 堆大小划分出约 2048 个区域。</p>
<p>-XX:ParallelGCThreads=n</p>
<p>设置 STW 工作线程数的值。将 n 的值设置为逻辑处理器的数量。n 的值与逻辑处理器的数量相同，最多为 8。</p>
<p>如果逻辑处理器不止八个，则将 n 的值设置为逻辑处理器数的 5/8 左右。这适用于大多数情况，除非是较大的 SPARC 系统，其中 n 的值可以是逻辑处理器数的 5/16 左右。</p>
<p>-XX:ConcGCThreads=n</p>
<p>设置并行标记的线程数。将 n 设置为并行垃圾回收线程数 (ParallelGCThreads) 的 1/4 左右。</p>
<p>-XX:InitiatingHeapOccupancyPercent=45</p>
<p>设置触发标记周期的 Java 堆占用率阈值。默认占用率是整个 Java 堆的 45%。</p>
<p>避免使用以下参数：</p>
<p>避免使用 -Xmn 选项或 -XX:NewRatio 等其他相关选项显式设置年轻代大小。固定年轻代的大小会覆盖暂停时间目标。</p>
<h3 id="触发Full-GC"><a href="#触发Full-GC" class="headerlink" title="触发Full GC"></a>触发Full GC</h3><p>在某些情况下，G1触发了Full GC，这时G1会退化使用Serial收集器来完成垃圾的清理工作，它仅仅使用单线程来完成GC工作，GC暂停时间将达到秒级别的。整个应用处于假死状态，不能处理任何请求，我们的程序当然不希望看到这些。那么发生Full GC的情况有哪些呢？</p>
<ul>
<li>并发模式失败</li>
</ul>
<p>G1启动标记周期，但在Mix GC之前，老年代就被填满，这时候G1会放弃标记周期。这种情形下，需要增加堆大小，或者调整周期（例如增加线程数-XX:ConcGCThreads等）。</p>
<ul>
<li>晋升失败或者疏散失败</li>
</ul>
<p>G1在进行GC的时候没有足够的内存供存活对象或晋升对象使用，由此触发了Full GC。可以在日志中看到(to-space exhausted)或者（to-space overflow）。解决这种问题的方式是：</p>
<pre><code>1. 增加 -XX:G1ReservePercent 选项的值（并相应增加总的堆大小），为“目标空间”增加预留内存量。

2. 通过减少 -XX:InitiatingHeapOccupancyPercent 提前启动标记周期。

3. 也可以通过增加 -XX:ConcGCThreads 选项的值来增加并行标记线程的数目。
</code></pre><ul>
<li>巨型对象分配失败</li>
</ul>
<p>当巨型对象找不到合适的空间进行分配时，就会启动Full GC，来释放空间。这种情况下，应该避免分配大量的巨型对象，增加内存或者增大-XX:G1HeapRegionSize，使巨型对象不再是巨型对象。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2018/03/27/reading/Effective-Java第三版读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/reading/Effective-Java第三版读书笔记/" itemprop="url">Effective Java第三版读书笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-27T20:06:05+08:00">2018-03-27</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-03-27T21:14:39+08:00">2018-03-27</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="对象的生成与销毁"><a href="#对象的生成与销毁" class="headerlink" title="对象的生成与销毁"></a>对象的生成与销毁</h1><h2 id="使用静态工厂方法代替构造器"><a href="#使用静态工厂方法代替构造器" class="headerlink" title="使用静态工厂方法代替构造器"></a>使用静态工厂方法代替构造器</h2><ul>
<li>工厂方法可以提供更好的命名, 如BigInteger.probablePrime()与BigInteger(int, int, Random). 倘若有两个构造器仅仅方法参数顺序不同, 其他人在使用时会懵逼. 这可以用被友好命名的工厂方法来替代.</li>
<li>工厂方法可以控制使用者何时去创建新对象. 如不可变类可以共享实例, 单例模式等, 从而提高性能. </li>
<li>工厂方法可以返回其返回类型的子类的实例. 如Collections, Executors等. (java 8起可以在接口里提供静态方法. java 9起可以在接口里提供私有静态方法)</li>
<li>基于上一条, 返回的实例可以是动态生成的或者随版本发布而升级实现的. 如EnumSet的RegularEnumSet与JumboEnumSet.</li>
<li>工厂方法返回的实例可以不存在实现的代码(起码在写这个工厂的时候, 实现可以让其他方搞). 如JDBC实现了JVM提供的接口.</li>
<li>仅提供静态工厂方法而没有public货protected的构造器的限制是不能拥有子类. </li>
<li>另一个缺点是: 静态工厂方法对于程序员不容易发现.</li>
</ul>
<h3 id="一些方法命名规则"><a href="#一些方法命名规则" class="headerlink" title="一些方法命名规则:"></a>一些方法命名规则:</h3><ul>
<li>from: 类型转换, 接收单个参数.</li>
<li>of: 接收多个参数, 聚合为一个结果.</li>
<li>valueOf: 可用来代替from与of.</li>
<li>instance,getInstance: 返回单例结果.</li>
<li>create,newInstance: 每次调用返回新实例.</li>
<li>get<em>Type</em>: 类似getInstance但是, 返回的是不同类型(type). 如FileStore fs = Files.getFileStore(path);</li>
<li>new<em>Type</em>: 类似newInstance, 返回不同类型.</li>
<li><em>type</em>: 前两者的简洁方式.</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2018/02/13/distribute/zk官方文档部分译文/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/13/distribute/zk官方文档部分译文/" itemprop="url">zk官方文档部分译文</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-02-13T14:11:05+08:00">2018-02-13</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2018-02-14T15:44:25+08:00">2018-02-14</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>refer:<a href="http://zookeeper.apache.org/doc/r3.4.11/zookeeperProgrammers.html" target="_blank" rel="noopener">官方文档</a></p>
<h1 id="zk数据模型"><a href="#zk数据模型" class="headerlink" title="zk数据模型"></a>zk数据模型</h1><p>zk的命名空间中的每个节点既能关联数据也能有子节点.节点的路径总是被表示为斜杠分割的绝对路径, 并且不允许使用相对路径. 路径的以及节点的命名遵守以下规则:</p>
<ul>
<li>不能包含空字符(\u0000).</li>
<li>不能包含无法显示字符:\u0001 - \u0019 and \u007F - \u009F.</li>
<li>不包含\ud800 -uF8FFF, \uFFF0 - uFFFF范围的字符.</li>
<li>“.”可以作为命名空间的组成, 但是不能单独使用(zk没有相对路径).</li>
<li>“zookeeper”被认为是保留字.</li>
</ul>
<h2 id="ZNodes"><a href="#ZNodes" class="headerlink" title="ZNodes"></a>ZNodes</h2><p>zk中的每个节点即是znode. znode维护着包含版本号, 权限控制列表, 时间戳等的状态结构. 版本号与时间戳让zk保证了数据的更新. 每一次znode的数据有变化, 版本号会增加, 每当客户端接收到变更数据时也会接收到对应的版本号. 当客户端执行更新或者删除操作时也必须提供对应的znode的版本号, 如果版本号不匹配当前的数据, 变更将会失败.</p>
<p>zk不适合作为存储系统而是用于管理协调数据. 存储的数据可以是配置信息, 状态等, 它们的共性是数据量较小(KB级别). 存储体积较大的数据会由于replica导致存储以及网络的开销造成延迟.</p>
<p>znode是程序员需要关注的主要对象. znode有以下几个指的被关注的特性:</p>
<ul>
<li><strong>Watches</strong>: clients能够在znode上设置watches. <strong>znode发生变更时能够触发并清除watch</strong>. 当watch被触发时, zk向client发送一个通知.</li>
<li><strong>Data Access</strong>: 存储在znode中的数据能够自动地被读写. 读能够获取znode中的所有数据, 对应地, 写也能替换znode中的所有数据. 每个znode有一个Access Control List (ACL)来做权限控制.</li>
<li><strong>Ephemeral Nodes</strong>: zk允许创建临时节点. 这种znode的生命周期与创建它的session连接相同, session结束znode即被删除.临时节点因为这种特性不允许拥有子节点. </li>
<li><strong>Sequence Nodes</strong>: 创建znode时, zk可以在路径的末尾添加唯一自增序号, 这种znode可以被用来实现分布式锁或者分布式队列.</li>
</ul>
<h2 id="Time-in-ZooKeeper"><a href="#Time-in-ZooKeeper" class="headerlink" title="Time in ZooKeeper"></a>Time in ZooKeeper</h2><ul>
<li><strong>Zxid</strong>: 每次zk状态的变更会接收到唯一且自增的zxid(ZooKeeper Transaction Id)形式的时间戳. 这代表着zk的所有变更的时序.</li>
<li><strong>Version numbers</strong>: znode的每次变更会导致该znode的version number加1. version代表znode的变更次数, cversion代表该znode的子节点的变更次数, aversion代表该znode的ACL的变更次数.</li>
<li><strong>Ticks</strong>: 当使用zk集群时, zk-server之间使用ticks来定义事件的事件状态. 例如状态上传, session超时, 链接超时等等. tick time间接地暴露了session的最小超时时间(往返tick时间). </li>
<li><strong>Real time</strong>: zk不使用real time或者clock time, 而是将时间戳保存在znode的状态结构中, 包括生成时间, 修改时间.</li>
</ul>
<h2 id="ZooKeeper-Stat-Structure"><a href="#ZooKeeper-Stat-Structure" class="headerlink" title="ZooKeeper Stat Structure"></a>ZooKeeper Stat Structure</h2><p>zk中的znode的状态结构由以下构成:</p>
<ul>
<li><strong>czxid</strong>: 该znode创建时的zxid.</li>
<li><strong>mzxid</strong>: 该znode最近修改时的zxid.</li>
<li><strong>pzxid</strong>: 该znode最近修改子节点时的zxid.</li>
<li><strong>ctime</strong>: 该znode创建时的毫秒时间戳.</li>
<li><strong>mtime</strong>: 该znode最近一次修改时的毫秒时间戳.</li>
<li><strong>version</strong>: 该znode的data修改次数.</li>
<li><strong>cversion</strong>: 该znode的子节点的修改次数.</li>
<li><strong>aversion</strong>: 该znode的ACL的修改次数.</li>
<li><strong>ephemeralOwner</strong>: 倘若该znode是临时节点, 代表创建者的sessionId. 若不是临时节点, 这个值为0.</li>
<li><strong>dataLength</strong>: 该znode的data的数据大小.</li>
<li><strong>numChildren</strong>: 该znode的子节点数量.</li>
</ul>
<h1 id="ZooKeeper-Sessions"><a href="#ZooKeeper-Sessions" class="headerlink" title="ZooKeeper Sessions"></a>ZooKeeper Sessions</h1><p>zk-client通过其语言绑定的实现连接到zk-service便创建一个session. session的状态图如下:</p>
<p><img src="http://zookeeper.apache.org/doc/r3.4.11/images/state_dia.jpg" alt=""></p>
<p>为了创建一个client-session, 应用需提供逗号分隔的host:port pairs. zk客户端会随机选中某个server地址并试图连接上去.如果这个连接失败了或者由于其他原因断开了, 客户端会自动连接下一个server直到连接被建立.</p>
<p><strong>Added in 3.2.0</strong>: 在连接的字符串后面可以添加chroot后缀, client的所有命令将会变为相对于该root的操作. 如:”127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a”. 这样做的好处是便于了隔离.</p>
<p>当client连接到zk-service后, zk创建一个64-bit的number代表zk的session并分配给client.如果client连接到另一个zk-server, 它将会把sessionId作为连接握手请求的一部分. 为了安全起见, server会给sessionId生成密码并在client创建session时返回给client. client在重连session到一个新的server时会发送密码与sessionId.</p>
<p>client创建zk-session时有一个超时时间的参数. 目前的实现要求超时时间至少是tickTime的两倍, 最大是tickTime的20倍.</p>
<p>当一个client(session)成为zk-cluster的一部分时, 它将在创建session时指定的server列表中搜索, 最终client与其中一个server的连接被建立后, session将会进入”connected”状态或者”expired”状态(取决于是否超时). 连接断开后我们不推荐你新建一个session对象, zk-client会为你处理重连. 只有接收到session过期事件后才会强制创建一个新的session.</p>
<p>session的过期是由zk-cluster自己管理的, 不是客户端. 当client建立与zk-cluster的session时提供了”timeout”参数. 这个值被zk-cluster用来决定何时client的session会过期. 当zk-cluster在timeout时间内接收不到消息时, 过期事件会发生. 当session过期后, zk-cluster会立即删除掉该session拥有的所有临时节点, 并且触发这些节点的watches. <strong>在这期间, 这个client依然与zk-cluster是失联状态, 它只有重连到集群上时才知道自己的session过期了</strong>.</p>
<p>过期的session的watcher观察到的state变化:</p>
<ol>
<li>connected: session建立了, client与zk-cluster通信中.</li>
<li>… client与zk-cluster发生了网络分区.</li>
<li>disconnected: client与zk-cluster断开连接了.</li>
<li>… 过了一段时间, 超时后, zk-cluster将该会话过期了, client还没意识到什么事情.</li>
<li>… 过了一段时间, client与zk-cluster网络恢复了.</li>
<li>expired: 最后client重连了zk-cluster, 它被通知超时了.</li>
</ol>
<p>session创建调用的另一个参数是默认的watcher. 当client的state发生任何变更时, watchers会被通知. 例如, 如果client与server失去了连接或者session过期了等, client会被通知. 该watcher应该考虑到断开连接的初始状态(如在client发送state变更事件给watcher之前). 比如新建连接时, 第一个发送给watcher的事件应该是session connection事件.</p>
<p>session通过client发送的心跳来保持存活状态. 心跳请求不仅让zk-server知道client是否活跃, 也让client知道server是否还正常. 心跳请求的间隔应该既能保证正常的使用, 也能及时检测到连接的断开从而重连到一个新的server.</p>
<p>一旦与server的连接被建立好, 基本上有两种情况会导致client发生connectionloss.</p>
<ol>
<li>该session已经挂掉了或者有问题.</li>
<li>client在向server发送请求期间connection断开了.</li>
</ol>
<p><strong>Added in 3.2.0 – SessionMovedException</strong>: 有一个clients通常看不见的exception叫做SessionMovedException. 当一个session重连到另一个server上后, 旧session继续发送请求时发生这个异常.这个异常发生的原因是客户端发送给server的请求由于网络延迟原因delay了, client重连到新的server上后这个包才到旧的server上. 旧server收到这个包后会主动关闭这些connection. clients通常看不到这些error是因为它们的旧connection已经关闭了. 一种情况下, clients能够看到这个错误是在两个client使用了相同的sessionId与密码去重连session并建立了相同的连接. 其中一个client会建立成功, 另一个会断开.</p>
<h1 id="ZooKeeper-Watches"><a href="#ZooKeeper-Watches" class="headerlink" title="ZooKeeper Watches"></a>ZooKeeper Watches</h1><p>zk中所有的读操作: getData(), getChildren(), exists() 有设置watch的选项. 这里是zk对于watch的定义: 一个watch event是一个一次性触发器, 当watch设置到的data发生变更时会被触发. 有三点需要注意的地方:</p>
<ul>
<li><strong>One-time trigger</strong>: 当data变更时, 一个watch event会被发送给client. 例如如果一个客户端操作getData(“/znode1”, true) 过了一会儿 /znode1 的data被改变或者删除了, 客户端会收到/znode1的watch event. 如果/znode1再一次改变了, 除非client再一次在读操作中设置了watch否则不会给client发送watch event.</li>
<li><strong>Sent to the client</strong>: 这个强调了一个event是单向发送给client的, 但是有可能在变更操作返回succ之后到达client. watches被异步地发送给watchers. zk提供了以下时序的保证: <strong>一个client永远不会在watch event到达之前看到数据的变更</strong>. 网络延迟或者其他因素可能导致不同的client接收watch event与update succ的时间不同. 但是关键之处在于不同的client看到的everything的顺序是不变的.</li>
<li><strong>The data for which the watch was set</strong>: 这个是指一个znode的变化会有不同的方式. 你可以认为zk维护着两组watches的list: data watches与child watches. getData()与exists()方法可以设置data watches, getChildren()方法可以设置child watches. 考虑到以上方法的返回数据, setData()将会触发data watches, create()将会触发生成的znode的data watch与其父节点的child watch, delete()将同样触发data watch与child watch.</li>
</ul>
<p>watches被client连接的zk-server本地维护. 这样设计使watches的维护,分发与触发变得轻量级. 当一个client连接到一个新的server上时, watch的session event将被触发. 当与server断开连接后, watches不会被接收到, 当client重新连接后, 如果需要, 之前注册的watches都将被重新注册并且触发. 有一种情况可能会导致watch丢失: 在watch的节点还未生成的情况下, 如果在断开连接期间，该节点被创建又被删除，那么watch事件会丢失.</p>
<h2 id="Semantics-of-Watches"><a href="#Semantics-of-Watches" class="headerlink" title="Semantics of Watches"></a>Semantics of Watches</h2><p>我们能够通过获取zk状态的三个读方法设置watches: exists(), getData(), getChildren(). 下方详细地列出了watch能够触发的事件与启用他们的调用:</p>
<ul>
<li>Created event: Enabled with a call to exists.</li>
<li>Deleted event: Enabled with a call to exists, getData, and getChildren.</li>
<li>Changed event: Enabled with a call to exists and getData.</li>
<li>Child event: Enabled with a call to getChildren.</li>
</ul>
<h2 id="What-ZooKeeper-Guarantees-about-Watches"><a href="#What-ZooKeeper-Guarantees-about-Watches" class="headerlink" title="What ZooKeeper Guarantees about Watches"></a>What ZooKeeper Guarantees about Watches</h2><ul>
<li>watches相对于其他时间, 其他watches, 异步相应来说是有序的. zk-client保证了所有分发的顺序.</li>
<li>对于一个znode, client收到的watch event总是在其看到新的数据之前.</li>
<li>来自zk的watch event的顺序取决于zk-service接收到update的顺序.</li>
</ul>
<h2 id="Things-to-Remember-about-Watches"><a href="#Things-to-Remember-about-Watches" class="headerlink" title="Things to Remember about Watches"></a>Things to Remember about Watches</h2><ul>
<li>watches是一次性的触发器. 如果你得到了一个watch event并且还想获得未来的变更通知, 你必须再设置另一个watch.</li>
<li><strong>因为watches是一次性触发器, 并且在获得event与发送新请求去获得一个watch之间有延迟, 你不能可靠地看到发生在zk中的znode的每个变更. 你要准备好去处理获取event与重设watch之间znode可能的多次变更的情况(你可能不关心这种情况, 但是至少你要知道它可能会发生).</strong></li>
<li>一个watch对象, 或者方法, 仅会被触发一次. 例如, 同一个watch对象既通过exists()操作也通过getData()注册了, 然后节点被删除了, watch对象将被触发一次. </li>
<li>当你与一个server断开连接时(例如server挂了), 你再重连之前不会收到任何watches. 因为这个原因, session events会被发送到所有的watch handlers. 使用session events来进入一个安全模式: 你可能在断开期间收不到任何events, 所以在这个模式下你应该谨慎地搞事情.</li>
</ul>
<h1 id="Java-Binding"><a href="#Java-Binding" class="headerlink" title="Java Binding"></a>Java Binding</h1><p>zk的java客户端由两个包组成: org.apache.zookeeper, org.apache.zookeeper.data, 剩下的包是zk内部使用的或者是zk-server的部分实现.</p>
<p>zk的java客户端使用的主要的类是ZooKeeper. 它有两个构造器, 区别仅仅是可选的sessionId与password. zk支持session恢复, 程序可以保存它的sessionId与password用来重启或恢复之前使用的session.</p>
<p>当一个zk对象被创建时, 同时会启动两个线程: 一个IO线程与一个event线程. 所有的IO由IO线程来处理(java-NIO). 所有的event回调由event线程来处理. session的重连或者心跳维护, 同步方法的相应也是在IO线程上. 异步方法的响应与watch event由event线程处理. 下面是这样来设计的特点:</p>
<ul>
<li>所有的异步调用与watcher回调会单线程按顺序执行. 调用者可以在回调用搞任何事情, 但是与此同时没有其他的回调会执行.</li>
<li>回调不会阻塞IO线程, 也不会阻塞同步调用的处理.</li>
<li>同步调用的返回可能是乱序的. 例如, 假定一个客户端进行以下处理: 在对节点/a异步读操作时设置了watch, 然后在读回调中对/a节点进行同步读. 在这种情况下, 如果在异步读与同步读中/a节点的数据发生了变更, 客户端将会在同步读相应前收到watch event, 因为异步回调是通过一个队列实现的.</li>
</ul>
<p>最后, 关闭操作很简单: 一旦ZooKeeper对象被关闭了或者接收到了session过期或者auth_failed事件, 这个ZooKeeper对象就是非法的. 在关闭的时候, 两个线程也会被关闭, 这之后的任何操作都不行啦.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2017/12/06/jdk/JDK-ThreadLocal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/06/jdk/JDK-ThreadLocal/" itemprop="url">JDK-ThreadLocal</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-06T16:30:07+08:00">2017-12-06</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-12-06T17:15:06+08:00">2017-12-06</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><p><code>ThreadLocal</code>意为线程本地变量, 使用了<code>Thread</code>类的域-<code>ThreadLocalMap</code>来实现数据的线程范围访问. 不同的线程操作的是各自的<code>ThreadLocalMap</code>.</p>
<p><code>ThreadLocalMap</code>本质是一个使用<strong>线性探测法</strong>实现的一个<code>HashMap</code>. 这个map的<strong>key是<code>ThreadLocal</code>对象, value是存储元素.</strong></p>
<p><code>ThreadLocalMap</code>继承了<code>WeakReference</code>, 它的key是弱引用. 这么做的方式是防止内存泄露:</p>
<ul>
<li><p>强引用key：<code>ThreadLocal</code>被设置为null，由于<code>ThreadLocalMap</code>持有<code>ThreadLocal</code>的强引用，如果不手动删除，那么<code>ThreadLocal</code>将不会回收，产生内存泄漏。</p>
</li>
<li><p>弱引用key：<code>ThreadLocal</code>被设置为null，由于<code>ThreadLocalMap</code>持有<code>ThreadLocal</code>的弱引用，<strong>即便不手动删除，<code>ThreadLocal</code>仍会被回收</strong>，<strong><code>ThreadLocalMap</code>在之后调用set()、getEntry()和remove()函数时会清除所有key为null的Entry。</strong></p>
</li>
</ul>
<p>需要注意的问题:</p>
<ul>
<li><p>ThreadLocalMap仅仅含有这些被动措施来补救内存泄漏问题。如果你在之后没有调用ThreadLocalMap的set()、getEntry()和remove()函数的话，那么仍然会存在内存泄漏问题。<br><strong>在使用线程池的情况下，如果不及时进行清理，内存泄漏问题事小，甚至还会产生程序逻辑上的问题。所以，为了安全地使用ThreadLocal，必须要像每次使用完锁就解锁一样，在每次使用完ThreadLocal后都要调用remove()来清理无用的Entry。</strong></p>
</li>
<li><p>子线程可继承父线程的<code>ThreadLocal</code> -&gt; <strong><code>InheritableThreadLocal</code></strong></p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2017/11/24/network/HTTPS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/24/network/HTTPS/" itemprop="url">HTTPS相关</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-24T17:19:00+08:00">2017-11-24</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-11-28T10:20:53+08:00">2017-11-28</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前一段儿时间去美团外卖组面试, 被问到HTTPS相关的问题, 回答的不是很好, 想着整理一下.</p>
<p>部分摘取自 &lt;&lt;图解HTTP&gt;&gt; </p>
<h2 id="未加密HTTP存在的问题"><a href="#未加密HTTP存在的问题" class="headerlink" title="未加密HTTP存在的问题"></a>未加密HTTP存在的问题</h2><ol>
<li>通信使用明文, 内容可能被窃听.</li>
<li>无法证明报文完整性, 内容可能被篡改.</li>
<li>不验证通信方的身份, 可能遭遇伪装.</li>
</ol>
<h2 id="加密HTTP的手段"><a href="#加密HTTP的手段" class="headerlink" title="加密HTTP的手段"></a>加密HTTP的手段</h2><ol>
<li><p>使用基于SSL(Secure Socket Layer, 安全套接层)或TLS(Transport Layer Security, 安全层传输协议)的<strong>HTTPS</strong>.</p>
<p> <strong>HTTPS是业界的标准加密做法.</strong></p>
</li>
<li><p>对内容加密.</p>
<p> 要求客户端和服务端同时具备加密与解密的机制, 但是内容仍有被篡改的风险.</p>
</li>
</ol>
<blockquote>
<p>TLS是以SSL为原型开发的, 可以统称为SSL. 目前主流版本分别是SSL3.0, TLS1.0.</p>
</blockquote>
<h2 id="HTTP-加密-认证-完整性保护-HTTPS"><a href="#HTTP-加密-认证-完整性保护-HTTPS" class="headerlink" title="HTTP+加密+认证+完整性保护 = HTTPS"></a>HTTP+加密+认证+完整性保护 = HTTPS</h2><blockquote>
<p>通常, HTTP直接和TCP通信. 当使用SSL时, 则演变成先和SSL通信, 再由SSL和TCP通信. 即由<code>HTTP-&gt;TCP-&gt;IP</code>演变为<code>HTTP-&gt;SSL-&gt;TCP-&gt;IP</code>.</p>
</blockquote>
<h4 id="两种加密方式"><a href="#两种加密方式" class="headerlink" title="两种加密方式:"></a>两种加密方式:</h4><ol>
<li><p>共享(对称)密钥加密.</p>
<p> 加密解密使用相同的密钥, 面临的困境是: 密钥安全地转交以及保管.</p>
</li>
<li><p>公开(非对称)密钥加密.</p>
<blockquote>
<p>解决了共享密钥加密的密钥转交问题.</p>
</blockquote>
<p> 使用一对密钥进行加密. 一把叫私有密钥, 一把为公开密钥.加密方式: 发送方使用对方的公钥加密, 对方收到加密的信息后, 再使用自己的私钥进行解密. </p>
<p> 根据密文与公钥解密原文是很困难的, 相当于对离散对数求值.</p>
</li>
</ol>
<h4 id="HTTPS使用混合加密机制"><a href="#HTTPS使用混合加密机制" class="headerlink" title="HTTPS使用混合加密机制:"></a>HTTPS使用混合加密机制:</h4><p>公开密钥加密与共享密钥加密相比, 其处理速度要慢. 故可以充分利用两者的优势: <strong>使用公开密钥加密方式交换共享密钥, 之后则使用共享密钥加密要传输的信息.</strong></p>
<p><img src="http://imgs.genshuixue.com/0baijiatools/59c0e69d130c7338b40ffda17b8051f3/WX20171127-1155212x.png" alt=""></p>
<h4 id="如何证明公钥的正确性–证书"><a href="#如何证明公钥的正确性–证书" class="headerlink" title="如何证明公钥的正确性–证书:"></a>如何证明公钥的正确性–证书:</h4><p>可以使用数字证书认证机构(CA, Certificate Authority)颁发的公钥证书.业务流程:</p>
<p><img src="http://imgs.genshuixue.com/0baijiatools/0dbcbabb9c9613ff3a23ef4d02b570f0/WX20171127-1430152x.png" alt=""></p>
<ol>
<li>服务器维护者向CA提出公钥申请.</li>
<li>CA判明申请者的身份, 对公钥做数字签名, 把公钥绑定到公钥证书.</li>
<li>服务器将这个CA颁发的公钥证书发送给客户端.</li>
<li>客户端对证书的数字签名进行验证. 验证通过则说明: CA的有效性, 服务器的公钥可信赖.</li>
<li>客户端使用公钥加密发送给服务端.</li>
<li>服务端使用私钥解密报文.</li>
</ol>
<blockquote>
<p>多数的开发商会事先在浏览器内部植入常用的CA的公开密钥, 以避免公钥的转交问题.</p>
</blockquote>
<h2 id="关于HTTPS的建立过程"><a href="#关于HTTPS的建立过程" class="headerlink" title="关于HTTPS的建立过程"></a>关于HTTPS的建立过程</h2><p><img src="http://imgs.genshuixue.com/0baijiatools/606049eaa591c639e7e5ec9ed99c3a81/WX20171127-1453162x.png" alt=""><br><img src="http://imgs.genshuixue.com/0baijiatools/4a020fd9774f39940ca3cd789664abfe/WX20171127-1452302x.png" alt=""><br><img src="http://imgs.genshuixue.com/0baijiatools/156b7054541e5ae04f1baff35a897ffe/WX20171127-1454552x.png" alt=""></p>
<ol>
<li>客户端首先会将自己支持的加密算法，打个包告诉服务器端。</li>
<li><p>服务器端从客户端发来的加密算法中，选出一组加密算法和HASH算法（注，HASH也属于加密），并将自己的身份信息以证书的形式发回给客户端。而证书中包含了网站的地址，加密用的公钥，以及证书的颁发机构等；</p>
<p> 这里有提到公钥的概念是故事中没有的。我们常见的加密算法一般是一些对称的算法，如凯撒加密；对称算法即加密用的密钥和解密用的密钥是一个。如故事中的密钥是4。还有一种加密解密算法称之为非对称算法。这种算法加密用的密钥（公钥）和解密用的密钥（私钥）是两个不同的密钥；通过公钥加密的内容一定要使用私钥才能够解密。</p>
<p> 这里，服务器就将自己用来加密用的公钥一同发还给客户端，而私钥则服务器保存着，用户解密客户端加密过后的内容。</p>
</li>
<li><p>客户端收到了服务器发来的数据包后，会做这么几件事情：</p>
<ul>
<li>验证一下证书是否合法。一般来说，证书是用来标示一个站点是否合法的标志。如果说该证书由权威的第三方颁发和签名的，则说明证书合法。</li>
<li>如果证书合法，或者客户端接受和信任了不合法的证书，则客户端就会随机产生一串序列号，使用服务器发来的公钥进行加密。这时候，一条返回的消息就基本就绪。</li>
<li>最后使用服务器挑选的HASH算法，将刚才的消息使用刚才的随机数进行加密，生成相应的消息校验值，与刚才的消息一同发还给服务器。</li>
</ul>
</li>
<li><p>服务器接受到客户端发来的消息后，会做这么几件事情：</p>
<ul>
<li>使用私钥解密上面第2）中公钥加密的消息，得到客户端产生的随机序列号。</li>
<li>使用该随机序列号，对该消息进行加密，验证的到的校验值是否与客户端发来的一致。如果一致则说明消息未被篡改，可以信任。</li>
<li>最后，使用该随机序列号，加上之前第2步中选择的加密算法，加密一段握手消息，发还给客户端。同时HASH值也带上。</li>
</ul>
</li>
<li><p>客户端收到服务器端的消息后，接着做这么几件事情：</p>
<ul>
<li>计算HASH值是否与发回的消息一致</li>
<li>检查消息是否为握手消息</li>
</ul>
</li>
<li><p>握手结束后，客户端和服务器端使用握手阶段产生的随机数以及挑选出来的算法进行对称加解密的传输。</p>
</li>
</ol>
<p>CBC模式的加密方法为: 将前一个明文块加密后XOR下一个明文块, 然后再对结果加密. 第一个块则需要特殊生成(上图中的初始向量).</p>
<p>协商决定加密组件相当于沟通选择彼此支持的加密算法.</p>
<h2 id="HTTPS存在的问题"><a href="#HTTPS存在的问题" class="headerlink" title="HTTPS存在的问题"></a>HTTPS存在的问题</h2><ol>
<li>通信慢. 除去了TCP连接与HTTP请求/响应外, 还需要进行SSL通信.</li>
<li>客户端与服务端都需要进行加密/解密的处理运算, 占用CPU与内存资源.</li>
<li>证书成本.</li>
</ol>
<p>处理办法: 只针对与敏感操作使用HTTPS加密.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2017/11/22/network/tcp知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/22/network/tcp知识/" itemprop="url">TCP连接-握手挥手, 重传, 流量控制, 拥塞控制等</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-22T16:00:00+08:00">2017-11-22</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-11-27T19:34:16+08:00">2017-11-27</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>非原创 部分摘取自 <a href="http://blog.csdn.net/kzq_qmi/article/details/46940463" target="_blank" rel="noopener">CSDN</a></p>
<p>原作者写的很棒</p>
<h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p>注意 seq ack syn</p>
<h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p>注意 fin ack 与断开后的等待两个TTL</p>
<h2 id="重传"><a href="#重传" class="headerlink" title="重传"></a>重传</h2><blockquote>
<p>报文重传是TCP最基本的错误恢复功能，它的目的是防止报文丢失。</p>
</blockquote>
<h3 id="超时重传"><a href="#超时重传" class="headerlink" title="超时重传"></a>超时重传</h3><p>决定报文是否有必要重传的主要机制是重传计时器（retransmission timer），它的主要功能是维护重传超时（<code>RTO</code>）值。当报文使用TCP传输时，重传计时器启动，收到ACK时计时器停止。报文发送至接收到ACK的时间称为往返时间（<code>RTT</code>）。<strong>对若干次时间取平均值，该值用于确定最终RTO值。</strong></p>
<p>每次发送数据包时，发送的数据报都有seq号，接收端收到数据后，会回复ack进行确认，表示某一seq号数据已经收到。当报文发送某个seq包之后，等待一段时间，但接收方尚未发送TCP ACK报文，发送方假设源报文丢失并将其重传。<strong>重传之后，RTO值加倍</strong>；如果在2倍RTO值到达之前还是没有收到ACK报文，就再次重传。如果仍然没有收到ACK，那么RTO值再次加倍。如此持续下去，<strong>每次重传RTO都翻倍</strong>，直到收到ACK报文或发送方达到配置的<strong>最大重传次数</strong>。 </p>
<p>最大重传次数取决于发送操作系统的配置值。默认情况下，Windows主机默认重传5次。大多数Linux系统默认最大15次。两种操作系统都可配置。</p>
<h3 id="快速重传"><a href="#快速重传" class="headerlink" title="快速重传"></a>快速重传</h3><p>接受数据一方发现有数据包丢掉了（并不是所期望的值或报文乱序）。就会发送<strong>重复ACK报文</strong>告诉发送端重传丢失的报文。 </p>
<p>当重传主机从<strong>发送端接收到3个重复ACK时</strong>，它会假设此报文确实在传送中丢失，并且立即发送一个<strong>快速重传</strong>。一旦触发了快速重传，所有正在传输的其他报文都被放入队列中，直到快速重传报文发送为止。过程如下图所示：</p>
<p><img src="http://img.blog.csdn.net/20150718102858936" alt=""></p>
<p>比较超时重传和快速重传，可以发现<strong>超时重传是发送端在傻等超时，然后触发重传</strong>；而<strong>快速重传则是接收端主动告诉发送端数据没收到，然后触发发送端重传</strong>。 </p>
<h2 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h2><blockquote>
<p>滑动窗口</p>
</blockquote>
<p>窗口大小”<strong>意味着接收方能接收数据的大小</strong>”，这也是说接收端设备再应用程序读取buffer中数据之前，能从对端连接处理多少数据。比如说server端窗口大小是360，那么就意味着server端一次只能从客户端接收不超过360bytes的数据。当server端收到数据，它会将数据放到buffer里，然后server端必须对这份数据做两件事：</p>
<ol>
<li>server端必须发送一个 ACK 到client端来确认数据已经收到 </li>
<li>server端必须处理这份数据，把它交给对应的应用程序</li>
</ol>
<p>接收方收到数据后会确认，但是数据并不一定是里面就是从buffer里取出的，这是受应用层逻辑控制的。所以很有可能如果接收数据过快，而取出数据更慢，就会导致buffer满。一旦这种情况发生，窗口大小就开始调整来防止接收方负载过高。</p>
<p>TCP头里有一个字段叫<strong>Window</strong>，又叫Advertised-Window，这个字段是<strong>接收端告诉发送端自己还有多少缓冲区可以接收数据</strong>。于是发送端就可以根据这个接收端的处理能力来发送数据，而不会导致接收端处理不过来。　　　Window是一个16bit位字段，它代表的是窗口的字节容量，也就是TCP的标准窗口最大为2^16-1=65535个字节。 </p>
<p>另外在TCP的选项字段中还包含了一个TCP窗口扩大因子，option-kind为3，option-length为3个字节，option-data取值范围0-14。窗口扩大因子用来扩大TCP窗口，可把原来16bit的窗口，扩大为31bit。 </p>
<p><img src="http://img.blog.csdn.net/20150718103040083" alt=""></p>
<p>对于TCP会话的发送方，任何时候在其发送缓存内的数据都可以分为4类，“已经发送并得到对端ACK的”，“已经发送但还未收到对端ACK的”，“未发送但对端允许发送的”，“未发送且对端不允许发送”。<strong>“已经发送但还未收到对端ACK的”和“未发送但对端允许发送的”这两部分数据称之为发送窗口。</strong></p>
<p><img src="http://img.blog.csdn.net/20150718103157063" alt=""><br><img src="http://img.blog.csdn.net/20150718103218167" alt=""></p>
<h3 id="滑动窗口协议"><a href="#滑动窗口协议" class="headerlink" title="滑动窗口协议"></a>滑动窗口协议</h3><ol>
<li><p>比特滑动窗口协议:</p>
<p> 当发送窗口和接收窗口的大小固定为1时，滑动窗口协议退化为停等协议（stop－and－wait）。<strong>该协议规定发送方每发送一帧后就要停下来，等待接收方已正确接收的确认（acknowledgement）返回后才能继续发送下一帧。</strong>由于接收方需要判断接收到的帧是新发的帧还是重新发送的帧，因此发送方要为每一个帧加一个序号。由于停等协议规定只有一帧完全发送成功后才能发送新的帧，因而只用一比特来编号就够了。</p>
</li>
<li><p>后退n协议:</p>
<p> 由于停等协议要为每一个帧进行确认后才继续发送下一帧，大大降低了信道利用率，因此又提出了后退n协议。后退n协议中，发送方在发完一个数据帧后，不停下来等待应答帧，而是连续发送若干个数据帧，即使在连续发送过程中收到了接收方发来的应答帧，也可以继续发送。且发送方在每发送完一个数据帧时都要设置超时定时器。只要在所设置的超时时间内仍未收到确认帧，就要重发相应的数据帧。如：<strong>当发送方发送了N个帧后，若发现该N帧的前一个帧在计时器超时后仍未返回其确认信息，则该帧被判为出错或丢失，此时发送方就不得不重新发送出错帧及其后的N帧</strong>。</p>
<p> 来看下面的例子，这里假设n=9：</p>
<p> <img src="http://img.blog.csdn.net/20150718103400908" alt=""></p>
<p> 首先发送方一口气发送10个数据帧，前面两个帧正确返回了，数据帧2出现了错误，这时发送方被迫重新发送2-8这7个帧，接受方也必须丢弃之前接受的3-8这几个帧。</p>
<p> 从这里不难看出，后退n协议<strong>一方面因连续发送数据帧而提高了效率</strong>，但另一方面，在重传时又必须<strong>把原来已正确传送过的数据帧进行重传使传送效率降低</strong>。由此可见，若传输信道的传输质量很差因而误码率较大时，连续测协议不一定优于停止等待协议。此协议中的发送窗口的大小为k，接收窗口仍是1。</p>
</li>
<li><p>选择重传协议:</p>
<p> 在后退n协议中，接收方若发现错误帧就不再接收后续的帧，即使是正确到达的帧，这显然是一种浪费。<strong>另一种效率更高的策略是当接收方发现某帧出错后，其后继续送来的正确的帧虽然不能立即递交给接收方的高层，但接收方仍可收下来，存放在一个缓冲区中，同时要求发送方重新传送出错的那一帧。</strong></p>
<p> 但是必须强调一点,接收方永远不会把分组失序地交给应用层.在他们被交付给应用层之前,先要等待那些更早发出来的分组到达。一旦收到重新传来的帧后，就可以原已存于缓冲区中的其余帧一并按正确的顺序递交高层。这种方法称为选择重发(SELECTICE REPEAT)，其工作过程如图所示。显然，选择重发减少了浪费，但要求接收方有足够大的缓冲区空间。 </p>
<p> <img src="http://img.blog.csdn.net/20150718103441574" alt=""></p>
</li>
</ol>
<h3 id="零窗口问题"><a href="#零窗口问题" class="headerlink" title="零窗口问题"></a>零窗口问题</h3><p>某些情况下，服务器无法再处理从客户端发送的数据。可能是由于内存不足，处理能力不够，或其他原因。这可能会造成数据被丢弃以及传输暂停，但接收窗口能够帮助减小负面影响。 </p>
<p>当上述情况发生时，服务器会发送<strong>窗口为0</strong>的报文。当客户端接收到此报文时，它会<strong>暂停所有数据传输</strong>，但会保持与服务器的连接以<strong>传输探测</strong>（keep-alive Zero Window Probe）报文。探测报文在客户端以稳定间隙发送，以查看服务器接收窗口状态。<strong>一旦服务器能够再次处理数据，将会返回非零值窗口大小</strong>，传输会恢复。下图示例了零窗口通知过程。</p>
<p><img src="http://img.blog.csdn.net/20150718103512042" alt=""></p>
<h2 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h2><p>滑动窗用来做流量控制。流量控制只关注发送端和接受端自身的状况，而没有考虑整个网络的通信情况。拥塞控制，则是基于整个网络来考虑的。考虑一下这样的场景：某一时刻网络上的延时突然增加，那么，TCP对这个事做出的应对只有重传数据，但是，重传会导致网络的负担更重，于是会导致更大的延迟以及更多的丢包，于是，这个情况就会进入恶性循环被不断地放大。试想一下，如果一个网络内有成千上万的TCP连接都这么行事，那么马上就会形成“网络风暴”，TCP这个协议就会拖垮整个网络。为此，TCP引入了拥塞控制策略。拥塞策略算法主要包括：<strong>慢启动，拥塞避免，拥塞发生，快速恢复。</strong></p>
<p>对于拥塞现象，我们可以进一步用下图来描述。当网络负载较小时，吞吐量基本上随着负载的增长而增长，呈线性关系，响应时间增长缓慢。当负载达到网络容量时，吞吐量呈现出缓慢增长，而响应时间急剧增加，这一点称为Knee。假如负载继续增加，路由器开始丢包，当负载超过一定量时，吞吐量开始急剧下降，这一点称为Cliff。 </p>
<p><img src="http://img.blog.csdn.net/20150718103749387" alt=""></p>
<p>拥塞控制机制实际上包含拥塞避免（congestion avoidance）和拥塞控制（congestion control）两种策略。前者的目的是使网络运行在Knee四周，避免拥塞的发生；而后者则是使得网络运行在Cliff的左侧区域。前者是一种“预防”措施，维持网络的高吞吐量、低延迟状态，避免进入拥塞；后者是一种“恢复”措施，使网络从拥塞中恢复过来，进入正常的运行状态。</p>
<ol>
<li><p>慢热启动算法:</p>
<p> TCP拥塞控制所使用的一种算法称为慢性启动（slow start），这种算法是基于这样的想法，它在开始时设置拥塞窗口大小（cwnd）<br>为一个最长段长度（MSS），每次接到一个确认时，窗口的大小就增加一个MSS值。窗口是慢速启动的，但是按<strong>指数规则增长</strong>。</p>
<ul>
<li>开始　　　　　—&gt; cwnd = 1 </li>
<li>经过1个RTT后 —&gt; cwnd = 2*1 = 2 </li>
<li>经过2个RTT后 —&gt; cwnd = 2*2= 4 </li>
<li>经过3个RTT后 —&gt; cwnd = 4*2 = 8</li>
<li><p>如果带宽为W，那么经过RTT*log2W时间就可以占满带宽。<br>　　<br><img src="http://img.blog.csdn.net/20150718104112095" alt=""></p>
<p>当然，慢速启动不能一直继续下去，到达某个值必须停止该阶段。发送方保存一个称为ssthresh（<strong>慢速启动阈值</strong>）变量，当拥塞窗口中的字节达到这个阈值时，慢速启动阶段结束而下一个阶段开始。在大多数实现中，ssthresh值是65536个字节。</p>
</li>
</ul>
</li>
<li><p>拥塞避免：加法增加:</p>
<p> 以慢速启动算法开始，则拥塞窗口大小按指数规则增长，这样增长太快了。为了在拥塞发生之前避免拥塞，必须降低指数增长的速度。 </p>
<p> 拥塞避免的主要思想是加法增大，也就是cwnd的值不再指数级往上升，开始<strong>加法增加</strong>。此时当窗口中所有的报文段都被确认时，cwnd的大小加1，cwnd的值就随着RTT开始线性增加，这样就可以<strong>避免增长过快导致网络拥塞，慢慢的增加调整到网络的最佳值</strong>。</p>
</li>
<li><p>拥塞发生算法：乘性减少:</p>
<p> <img src="http://img.blog.csdn.net/20150718104228469" alt=""></p>
<p> 之前提到过，重传是在两种情况下发生：</p>
<ol>
<li><strong>如果RTO超时，那么存在非常严重的拥塞的可能性</strong>；包可能已在网络中丢失。在这种情况下，<strong>TCP做出强烈的反应</strong>。 <ul>
<li><strong>设置阈值为cwnd的一半</strong>。 </li>
<li><strong>重新设置cwnd为1</strong>。 </li>
<li><strong>启动慢速启动阶段</strong>。</li>
</ul>
</li>
</ol>
</li>
</ol>
<pre><code>2. 如果**收到3个相同的ACK，那么存在着轻度拥塞**的可能性。TCP在收到乱序到达包时就会立即发送ACK，TCP利用3个相同的ACK来判定数据包的丢失，此时进行快速重传。 在这种情况下**，TCP做出轻度的反应**。 
    * **设置阈值为cwnd的一半。** 
    * **设置cwnd为阈值（有些实现是阈值加上3)**
    * **启动拥塞避免阶段**。
</code></pre><ol start="4">
<li><p>快速恢复:</p>
<p> “快速恢复”算法是在“快速重传”算法后添加的，<strong>当收到3个重复ACK时，TCP最后进入的不是拥塞避免阶段，而是快速恢复阶段。</strong>快速重传和快速恢复算法一般同时使用。快速恢复的思想是“数据包守恒”原则，即同一个时刻在网络中的数据包数量是恒定的，只有当“老”数据包离开了网络后，才能向网络中发送一个“新”的数据包，如果发送方收到一个重复的ACK，那么根据TCP的ACK机制就表明有一个数据包离开了网络，于是cwnd加1。如果能够严格按照该原则那么网络中很少会发生拥塞，事实上拥塞控制的目的也就在修正违反该原则的地方。 </p>
<p> 快速恢复状态是一种介于慢启动和拥塞避免之间的状态。它像慢启动，其中cwnd以指数增长，但是cwnd以ssthresh加3MSS（而不是1）开始。当TCP进入快速恢复阶段，可能发生三种主要事件。如果重复ACK继续到达，那么TCP保持这种状态，但是cwnd呈指数增长。如果发生超时，TCP假设网络中有真实的拥塞，并进入慢启动状态。如果一个新的（非重复）ACK到达，TCP进入拥塞避免阶段，但是将cwnd的大小减小到ssthresh值，好像三次重复ACK没有发生过一样，并且转换是从慢启动状态到拥塞避免状态。 </p>
<p> 具体来说快速恢复的主要步骤是： </p>
<ol>
<li><p><strong>当收到3个重复ACK时，把ssthresh设置为cwnd的一半，把cwnd设置为ssthresh的值加3，然后重传丢失的报文段，加3的原因是因为收到3个重复的ACK，表明有3个“老”的数据包离开了网络。</strong> </p>
</li>
<li><p><strong>再收到重复的ACK时，拥塞窗口增加1。</strong></p>
</li>
<li><p><strong>当收到新的数据包的ACK时，把cwnd设置为第一步中的ssthresh的值。原因是因为该ACK确认了新的数据，说明从重复ACK时的数据都已收到，该恢复过程已经结束，可以回到恢复之前的状态了，也即再次进入拥塞避免状态。注意，如果在此过程出现超时，则重新进入慢启动阶段。</strong></p>
</li>
</ol>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2017/11/20/es/Elasticsearch-manner-8-java-client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/20/es/Elasticsearch-manner-8-java-client/" itemprop="url">Elasticsearch使用要点(八)-Java客户端</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-20T11:40:44+08:00">2017-11-20</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-12-04T17:58:08+08:00">2017-12-04</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="java两种客户端"><a href="#java两种客户端" class="headerlink" title="java两种客户端"></a>java两种客户端</h2><ol>
<li><p>节点客户端 TransportClient</p>
<ul>
<li>生成过程中报异常需close(),否则有线程泄露风险.</li>
<li><code>client.transport.sniff</code>参数, 开启机器探测功能.</li>
</ul>
</li>
</ol>
<p>待续…</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2017/11/16/jdk/JDK-StringBuilder /">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/16/jdk/JDK-StringBuilder /" itemprop="url">JDK-StringBuilder</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-16T22:25:07+08:00">2017-11-16</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-11-16T23:12:47+08:00">2017-11-16</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="先说String"><a href="#先说String" class="headerlink" title="先说String"></a>先说String</h2><p>String类被final修饰, 不可以被继承. 内部用char数组来保存字符串, 并且类变量多数也是final的, 一些操作方法比如:substring(), concat()等方法都是构造一个新的char数组, new一个String对象来实现的. 字符串用”+”连接相当于新建了一个String对象.(编译器识别到字符串相加操作会优化成StringBuilder, 同时若编译期间就能确定字符串相加的值或final域, 那么会直接被优化为结果).</p>
<p>不可变类可是使用池技术来优化相同内容的对象占用的内存空间. 结合intern()方法, 可以把new出来的String对象刷新入常量池.</p>
<h4 id="问题-String-str-new-String-“abc”-创建了多少个对象"><a href="#问题-String-str-new-String-“abc”-创建了多少个对象" class="headerlink" title="问题: String str = new String(“abc”) 创建了多少个对象?"></a>问题: String str = new String(“abc”) 创建了多少个对象?</h4><pre><code>类加载? 代码执行?
</code></pre><h2 id="StringBuilder"><a href="#StringBuilder" class="headerlink" title="StringBuilder"></a>StringBuilder</h2><h4 id="StringBuilder内部持有非final的char数组-类似ArrayList有扩容机制"><a href="#StringBuilder内部持有非final的char数组-类似ArrayList有扩容机制" class="headerlink" title="StringBuilder内部持有非final的char数组, 类似ArrayList有扩容机制:"></a>StringBuilder内部持有非final的char数组, 类似ArrayList有扩容机制:</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在执行append前, 会确保容量</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minimumCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="comment">// 超过了长度了</span></span><br><span class="line">    <span class="keyword">if</span> (minimumCapacity - value.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        value = Arrays.copyOf(value, newCapacity(minimumCapacity));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">newCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="comment">// 这里长度翻倍</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = (value.length &lt;&lt; <span class="number">1</span>) + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (newCapacity &lt;= <span class="number">0</span> || MAX_ARRAY_SIZE - newCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        ? hugeCapacity(minCapacity)</span><br><span class="line">        : newCapacity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Integer.MAX_VALUE - minCapacity &lt; <span class="number">0</span>) &#123; <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE)</span><br><span class="line">        ? minCapacity : MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="null-safe"><a href="#null-safe" class="headerlink" title="null safe"></a>null safe</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// null值时执行下面代码</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> AbstractStringBuilder <span class="title">appendNull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = count;</span><br><span class="line">    ensureCapacityInternal(c + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">char</span>[] value = <span class="keyword">this</span>.value;</span><br><span class="line">    value[c++] = <span class="string">'n'</span>;</span><br><span class="line">    value[c++] = <span class="string">'u'</span>;</span><br><span class="line">    value[c++] = <span class="string">'l'</span>;</span><br><span class="line">    value[c++] = <span class="string">'l'</span>;</span><br><span class="line">    count = c;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="StringBuffer"><a href="#StringBuffer" class="headerlink" title="StringBuffer"></a>StringBuffer</h2><p>这个嘛, StringBuilder方法加同步.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2017/11/07/algorithm/算法-二叉树构造遍历等/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/07/algorithm/算法-二叉树构造遍历等/" itemprop="url">算法: 二叉树构造遍历等</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-07T11:38:00+08:00">2017-11-07</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-11-07T11:44:10+08:00">2017-11-07</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>废话不多说, 上代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hongyan.learn.test.dataStructures;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Deque;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> weihongyan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> binary tree</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 10/03/2017</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BuildTreeFromTraversalAndConvertTreeToTraversal</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] preOrder = &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">8</span>, <span class="number">9</span> &#125;;</span><br><span class="line">        <span class="keyword">int</span>[] inOrder = &#123; <span class="number">5</span>, <span class="number">4</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">9</span> &#125;;</span><br><span class="line">        <span class="keyword">int</span>[] postOrder = &#123; <span class="number">5</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">1</span> &#125;;</span><br><span class="line">        TreeNode root = <span class="keyword">this</span>.preOrderInOrderBuild(preOrder, <span class="number">0</span>, inOrder, <span class="number">0</span>, inOrder.length - <span class="number">1</span>);</span><br><span class="line">        TreeNode root2 = <span class="keyword">this</span>.postOrderInOrderBuild(postOrder, postOrder.length - <span class="number">1</span>, inOrder, <span class="number">0</span>, inOrder.length - <span class="number">1</span>);</span><br><span class="line">        List&lt;Integer&gt; preResult = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.preTraversalRecur(root, preResult);</span><br><span class="line">        System.out.println(preResult);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.preTraversalIter(root2));</span><br><span class="line">        List&lt;Integer&gt; inResult = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.inTraversalRecur(root, inResult);</span><br><span class="line">        System.out.println(inResult);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.inTraversalIter(root2));</span><br><span class="line">        List&lt;Integer&gt; postResult = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">this</span>.postTraversalRecur(root, postResult);</span><br><span class="line">        System.out.println(postResult);</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.postTraversalIter(root2));</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.levelTraversal(root));</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.levelTraversal(root2));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * preOrder recursion traversal</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preTraversalRecur</span><span class="params">(TreeNode node, List&lt;Integer&gt; result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == node) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        result.add(node.val);</span><br><span class="line">        preTraversalRecur(node.left, result);</span><br><span class="line">        preTraversalRecur(node.right, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * preOrder traversal iteration</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">preTraversalIter</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Deque&lt;TreeNode&gt; stack = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        TreeNode temp = root;</span><br><span class="line">        <span class="keyword">while</span> (temp != <span class="keyword">null</span> || stack.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (temp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stack.push(temp);</span><br><span class="line">                result.add(temp.val);</span><br><span class="line">                temp = temp.left;</span><br><span class="line">            &#125;</span><br><span class="line">            temp = stack.pop().right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * inOrder recursion traversal</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inTraversalRecur</span><span class="params">(TreeNode node, List&lt;Integer&gt; result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == node) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        inTraversalRecur(node.left, result);</span><br><span class="line">        result.add(node.val);</span><br><span class="line">        inTraversalRecur(node.right, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * inOrder traversal Iteration</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">inTraversalIter</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Deque&lt;TreeNode&gt; stack = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        TreeNode temp = root;</span><br><span class="line">        <span class="keyword">while</span> (temp != <span class="keyword">null</span> || stack.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (temp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stack.push(temp);</span><br><span class="line">                temp = temp.left;</span><br><span class="line">            &#125;</span><br><span class="line">            temp = stack.pop();</span><br><span class="line">            result.add(temp.val);</span><br><span class="line">            temp = temp.right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * postOrder recursion traversal</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postTraversalRecur</span><span class="params">(TreeNode node, List&lt;Integer&gt; result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == node) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        postTraversalRecur(node.left, result);</span><br><span class="line">        postTraversalRecur(node.right, result);</span><br><span class="line">        result.add(node.val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * postOrder iteration traversal</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">postTraversalIter</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        LinkedList&lt;Integer&gt; resultQueue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        Deque&lt;TreeNode&gt; stack = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        TreeNode temp = root;</span><br><span class="line">        <span class="keyword">while</span> (temp != <span class="keyword">null</span> || stack.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">while</span> (temp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                stack.push(temp);</span><br><span class="line">                resultQueue.addFirst(temp.val);</span><br><span class="line">                temp = temp.right;</span><br><span class="line">            &#125;</span><br><span class="line">            temp = stack.pop().left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resultQueue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * build a binary tree from preOrder and inOrder</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preOrder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preStart</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inOrder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inStart</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inEnd</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">preOrderInOrderBuild</span><span class="params">(<span class="keyword">int</span>[] preOrder, <span class="keyword">int</span> preStart, <span class="keyword">int</span>[] inOrder, <span class="keyword">int</span> inStart, <span class="keyword">int</span> inEnd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (preStart &gt;= preOrder.length || inStart &gt; inEnd) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode root = <span class="keyword">new</span> TreeNode(preOrder[preStart]);</span><br><span class="line">        <span class="keyword">int</span> pos = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = inStart; i &lt;= inEnd; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inOrder[i] == preOrder[preStart]) &#123;</span><br><span class="line">                pos = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        root.left = preOrderInOrderBuild(preOrder, preStart + <span class="number">1</span>, inOrder, inStart, pos - <span class="number">1</span>);</span><br><span class="line">        root.right = preOrderInOrderBuild(preOrder, preStart + (pos - inStart) + <span class="number">1</span>, inOrder, pos + <span class="number">1</span>, inEnd);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * build a binary tree from postOrder and inOrder</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> postOrder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> postEnd</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inOrder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inStart</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inEnd</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">postOrderInOrderBuild</span><span class="params">(<span class="keyword">int</span>[] postOrder, <span class="keyword">int</span> postEnd, <span class="keyword">int</span>[] inOrder, <span class="keyword">int</span> inStart, <span class="keyword">int</span> inEnd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (postEnd &lt; <span class="number">0</span> || inStart &gt; inEnd) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode root = <span class="keyword">new</span> TreeNode(postOrder[postEnd]);</span><br><span class="line">        <span class="keyword">int</span> pos = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = inStart; i &lt;= inEnd; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (postOrder[postEnd] == inOrder[i]) &#123;</span><br><span class="line">                pos = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        root.left = <span class="keyword">this</span>.postOrderInOrderBuild(postOrder, postEnd - (inEnd - pos) - <span class="number">1</span>, inOrder, inStart, pos - <span class="number">1</span>);</span><br><span class="line">        root.right = <span class="keyword">this</span>.postOrderInOrderBuild(postOrder, postEnd - <span class="number">1</span>, inOrder, pos + <span class="number">1</span>, inEnd);</span><br><span class="line">        <span class="keyword">return</span> root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * fucking failed! can not build a tree from preOrder and postOrder</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preOrder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preStart</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preEnd</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> postOrder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> postStart</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> postEnd</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">preOrderPostOrderBuild</span><span class="params">(<span class="keyword">int</span>[] preOrder, <span class="keyword">int</span> preStart, <span class="keyword">int</span> preEnd, <span class="keyword">int</span>[] postOrder, <span class="keyword">int</span> postStart,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> postEnd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (preStart &gt; preEnd || postStart &gt; postEnd) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        TreeNode root = <span class="keyword">new</span> TreeNode(preOrder[preStart]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * level traversal</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> root</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">levelTraversal</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Deque&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        queue.offer(root);</span><br><span class="line">        TreeNode temp;</span><br><span class="line">        <span class="keyword">while</span> (queue.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = queue.size(); i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">                temp = queue.poll();</span><br><span class="line">                result.add(temp.val);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != temp.left) &#123;</span><br><span class="line">                    queue.offer(temp.left);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != temp.right) &#123;</span><br><span class="line">                    queue.offer(temp.right);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> val;</span><br><span class="line">        TreeNode left;</span><br><span class="line">        TreeNode right;</span><br><span class="line"></span><br><span class="line">        TreeNode(<span class="keyword">int</span> val) &#123;</span><br><span class="line">            <span class="keyword">this</span>.val = val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.vonyan.cn/2017/11/07/algorithm/算法-最大子数组之和/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="weihongyan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="樱丸小头子的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/07/algorithm/算法-最大子数组之和/" itemprop="url">算法: 最大子数组之和</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-07T11:38:00+08:00">2017-11-07</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2017-11-07T11:39:26+08:00">2017-11-07</time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术文章/" itemprop="url" rel="index"><span itemprop="name">技术文章</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>given an integer array, find the max sum of subSequence</p>
</blockquote>
<p>上代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hongyan.learn.common.algorithm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> weihongyan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 24/01/2017</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * given an integer array, find the max sum of subSequence</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MaxSumSubSequence</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] array = &#123; <span class="number">4</span>, -<span class="number">3</span>, <span class="number">5</span>, -<span class="number">2</span>, -<span class="number">1</span>, <span class="number">2</span>, -<span class="number">6</span>, -<span class="number">2</span>, -<span class="number">5</span>, <span class="number">6</span>, -<span class="number">2</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">3</span>, -<span class="number">12</span> &#125;;</span><br><span class="line">        log.error(<span class="string">"n3_solve result:&#123;&#125;"</span>, n3_solve(array));</span><br><span class="line">        log.error(<span class="string">"n2_solve result:&#123;&#125;"</span>, n2_solve(array));</span><br><span class="line">        log.error(<span class="string">"nlogn_solve result:&#123;&#125;"</span>, nlogn_solve(array));</span><br><span class="line">        log.error(<span class="string">"n_solve result:&#123;&#125;"</span>, n_solve(array));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">n3_solve</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;<span class="comment">// left</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; array.length; j++) &#123;<span class="comment">// right</span></span><br><span class="line">                <span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> k = i; k &lt;= j; k++) &#123;<span class="comment">// inner</span></span><br><span class="line">                    temp += array[k];</span><br><span class="line">                &#125;</span><br><span class="line">                max = Math.max(max, temp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">n2_solve</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;<span class="comment">// left</span></span><br><span class="line">            <span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; array.length; j++) &#123;<span class="comment">// right</span></span><br><span class="line">                temp += array[j];</span><br><span class="line">                max = Math.max(max, temp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// devide and conqure</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nlogn_solve</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> devConq(array, <span class="number">0</span>, array.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">devConq</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">            <span class="keyword">return</span> array[start] &lt; <span class="number">0</span> ? <span class="number">0</span> : array[start];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> middle = (start + end) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">int</span> leftMaxSub = devConq(array, start, middle);</span><br><span class="line">        <span class="keyword">int</span> rightMaxSub = devConq(array, middle + <span class="number">1</span>, end);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> leftMaxBorder = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> leftMaxBorderTemp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = middle; i &gt;= start; i--) &#123;</span><br><span class="line">            leftMaxBorderTemp += array[i];</span><br><span class="line">            leftMaxBorder = Math.max(leftMaxBorder, leftMaxBorderTemp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> rightMaxBorder = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> rightMaxBorderTemp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = middle + <span class="number">1</span>; i &lt;= end; i++) &#123;</span><br><span class="line">            rightMaxBorderTemp += array[i];</span><br><span class="line">            rightMaxBorder = Math.max(rightMaxBorder, rightMaxBorderTemp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> maxInner = leftMaxBorder + rightMaxBorder;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Math.max(Math.max(maxInner, leftMaxSub), rightMaxSub);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">n_solve</span><span class="params">(<span class="keyword">int</span>[] array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> temp = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">            temp += array[i];</span><br><span class="line">            temp = temp &lt; <span class="number">0</span> ? <span class="number">0</span> : temp;</span><br><span class="line">            max = Math.max(max, temp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="weihongyan" />
            
              <p class="site-author-name" itemprop="name">weihongyan</p>
              <p class="site-description motion-element" itemprop="description">一人我饮酒醉 七八个小姐姐一起睡</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/weiazm" target="_blank" title="GitHub"><i class="fa fa-fw fa-globe"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://leetcode.com/weihongyan" target="_blank" title="LeetCode"><i class="fa fa-fw fa-globe"></i>LeetCode</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://weibo.com/3569209981" target="_blank" title="微博"><i class="fa fa-fw fa-globe"></i>微博</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">weihongyan</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.4</div>




<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

<span class="post-meta-divider">|</span>

<span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
</span>

<span class="post-meta-divider">|</span>

<span id="busuanzi_container_site_uv">
  访客数<span id="busuanzi_value_site_uv"></span>人次
</span>
        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.4"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
